<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="../static/css/styles2.css">
</head>

<body>
    <div class="navbar">
        <ul>
            <div class="logo">
                <img src="../static/img/ublogo.png" alt="University Logo">
            </div>
            <li><a href="/">Home</a></li>
            <li><a href="/convert">Convert</a></li>
            <li><a href="/book">Lessons</a></li>
        </ul>
    </div>

    <button class="toc-toggle-btn" id="tocToggleBtn">☰ TOC</button>

    <div class="toc-container" id="tocContainer">
        <div class="toc-header">
            Table of Contents
        </div>
        <div class="toc-content">
            <ul>
                <li><a href="#chapter1">Chapter 1: Introduction</a></li>
                <ul>
                    <li><a href="#topic1">Topic 1: Overview</a></li>
                    <li><a href="#topic2">Topic 2: Basics</a></li>
                </ul>
                <li><a href="#chapter2">Chapter 2: Advanced Topics</a></li>
                <ul>
                    <li><a href="#topic3">Topic 3: Deep Dive</a></li>
                    <li><a href="#topic4">Topic 4: Case Studies</a></li>
                </ul>
                <li><a href="#chapter3">Chapter 3: Conclusion</a></li>
            </ul>
        </div>
    </div>

    <div class="con-commands">
        <div class="commands">
            <div class="btn-read">
                <button id="readBtn"><ion-icon name="book"></ion-icon></button>
            </div>

            <div class="btn-pause">
                <button id="pauseBtn" disabled><ion-icon name="pause"></ion-icon></button>
            </div>

            <div class="btn-stop">
                <button id="stopBtn" disabled><ion-icon name="stop"></ion-icon></button>
            </div>

            <div class="btn-command">
                <button id="speech-command"><ion-icon name="mic"></ion-icon></button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="con-card">
            <h1>{{ title }}</h1>
            {% for paragraph in content %}
            <div class="paragraph-container">
                <p>
                    {% set processed_paragraph = paragraph.replace('\n', '<br>').replace('<bold>', '<strong>').replace('
                    </bold>',
                    '</strong>').replace('<em>', '<em>').replace('</em>', '</em>') %}
                    {% for word in processed_paragraph.split() %}
                    <span class="word">{{ word|safe }}</span>
                    <!-- Add a space after each word except the last -->
                    {% if not loop.last %}
                    <span class="space"> </span>
                    {% endif %}
                    {% endfor %}
                </p>
            </div>
            {% endfor %}

            <!-- Dropdown for voice selection -->
            <label for="voiceSelect">Choose Voice:</label>
            <select id="voiceSelect"></select>

            <!-- Navigation -->
            <div id="pagination" class="navigation"></div>

        </div>
    </div>

    <!-- Your existing scripts -->
    <script src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js" type="module"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!-- Modified Script for Highlighting -->
    <script>
        let speechSynthesisUtterance;
        let voices = [];
        let isPaused = false;
        let wordList = [];
        let currentWordIndex = 0;

        // Load available voices
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = ''; // Clear existing options
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = voice.name + (voice.default ? " (default)" : "");
                voiceSelect.appendChild(option);
            });
        }

        // Initialize word list
        function initializeWordList() {
            wordList = [];
            const paragraphs = document.querySelectorAll('.paragraph-container p');
            paragraphs.forEach(paragraph => {
                const words = paragraph.querySelectorAll('.word');
                words.forEach(word => {
                    wordList.push(word);
                });
            });
        }

        // Read text with speech synthesis and highlight words
        function readText() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel(); // Stop ongoing speech before starting new
            }

            initializeWordList(); // Initialize word list
            currentWordIndex = 0; // Reset word index

            const selectedVoiceIndex = document.getElementById('voiceSelect').value;
            const selectedVoice = voices[selectedVoiceIndex];
            const textToRead = wordList.map(word => word.textContent).join(' ');

            speechSynthesisUtterance = new SpeechSynthesisUtterance(textToRead);
            speechSynthesisUtterance.voice = selectedVoice;

            // Handle word boundary events
            speechSynthesisUtterance.onboundary = (event) => {
                if (event.name === 'word') {
                    // Calculate the word index based on character index
                    const charIndex = event.charIndex;
                    const spokenText = textToRead.substring(0, charIndex);
                    const wordsSpoken = spokenText.trim().split(/\s+/).length;
                    highlightWord(wordsSpoken - 1);
                }
            };

            speechSynthesisUtterance.onend = () => {
                removeHighlight(currentWordIndex);
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('readBtn').disabled = false;
            };

            speechSynthesis.speak(speechSynthesisUtterance);
            document.getElementById('readBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
        }

        // Highlight the current word
        function highlightWord(index) {
            // Remove existing highlights
            wordList.forEach(word => word.classList.remove('highlight'));

            if (index >= 0 && index < wordList.length) {
                wordList[index].classList.add('highlight');
                currentWordIndex = index;
                // Scroll into view if needed
                wordList[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Remove highlight from a specific word
        function removeHighlight(index) {
            if (index >= 0 && index < wordList.length) {
                wordList[index].classList.remove('highlight');
            }
        }

        // Pause or resume speech synthesis
        function togglePauseResume() {
            if (!isPaused) {
                speechSynthesis.pause();
                document.getElementById('pauseBtn').innerHTML = '<ion-icon name="play"></ion-icon>';
            } else {
                speechSynthesis.resume();
                document.getElementById('pauseBtn').innerHTML = '<ion-icon name="pause"></ion-icon>';
            }
            isPaused = !isPaused;
        }

        // Stop speech synthesis
        function stopSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            wordList.forEach(word => word.classList.remove('highlight'));
            document.getElementById('readBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').innerHTML = '<ion-icon name="play"></ion-icon>';
            isPaused = false;
        }

        // Speech recognition commands (updated)
        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert("Your browser does not support Speech Recognition.");
                return;
            }

            // Initialize SpeechRecognition
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;  // Continuous listening
            recognition.lang = 'en-US';     // Set language to English
            recognition.interimResults = true; // Get results even if not final

            let recognizing = false; // Track whether recognition is active

            // Start or stop recognition when mic button is clicked
            document.getElementById('speech-command').addEventListener('click', () => {
                if (recognizing) {
                    recognition.stop(); // Stop listening
                    recognizing = false;
                    document.getElementById('speech-command').innerHTML = '<ion-icon name="mic"></ion-icon>'; // Change icon to mic
                } else {
                    recognition.start(); // Start listening
                    recognizing = true;
                    document.getElementById('speech-command').innerHTML = '<ion-icon name="mic-off"></ion-icon>'; // Change icon to mic-off
                }
            });

            // Handle recognized speech results
            recognition.onresult = (event) => {
                const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
                console.log("Recognized command:", command);

                function speakAndExecute(message, action) {
                    const confirmation = new SpeechSynthesisUtterance(message);
                    confirmation.onend = action;
                    window.speechSynthesis.speak(confirmation);
                }

                // Navigate to the next page
                if (command.includes("next page")) {
                    const currentUrl = window.location.href;
                    const match = currentUrl.match(/lesson\/laborlaw(\d+)/);
                    if (match) {
                        const currentPage = parseInt(match[1], 10);
                        const nextPage = currentPage + 1;
                        const nextUrl = `/lesson/laborlaw${nextPage}`;
                        speakAndExecute("Navigating to the next page.", () => window.location.href = nextUrl);
                    } else {
                        speakAndExecute("Could not determine the next page.", null);
                    }
                }
                // Navigate to the previous page
                else if (command.includes("previous page")) {
                    const currentUrl = window.location.href;
                    const match = currentUrl.match(/lesson\/laborlaw(\d+)/);
                    if (match) {
                        const currentPage = parseInt(match[1], 10);
                        if (currentPage > 1) {
                            const previousPage = currentPage - 1;
                            const prevUrl = `/lesson/laborlaw${previousPage}`;
                            speakAndExecute("Going to the previous page.", () => window.location.href = prevUrl);
                        } else {
                            speakAndExecute("You are already on the first page.", null);
                        }
                    } else {
                        speakAndExecute("Could not determine the previous page.", null);
                    }
                }
                // Navigate to the home page
                else if (command.includes("go to home")) {
                    speakAndExecute("Returning to home page.", () => window.location.href = '/');
                }
                // Stop the audio
                else if (command.includes("stop")) {
                    speakAndExecute("Stopping the audio.", () => stopSpeech());
                }
                // Pause or resume the audio
                else if (command.includes("pause")) {
                    speakAndExecute("Pausing the audio.", () => togglePauseResume());
                }
                // Read aloud
                else if (command.includes("read")) {
                    speakAndExecute("Reading aloud.", () => readText());
                }
            };

            // Handle errors in speech recognition
            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                recognizing = false;
                document.getElementById('speech-command').innerHTML = '<ion-icon name="mic"></ion-icon>'; // Reset mic icon
            };

            // Restart recognition once it ends (for continuous listening)
            recognition.onend = () => {
                if (recognizing) {
                    recognition.start(); // Restart recognition after it ends
                }
            };
        }

        // Handle page load
        document.addEventListener('DOMContentLoaded', () => {
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices();
            }
            document.getElementById('readBtn').addEventListener('click', readText);
            document.getElementById('pauseBtn').addEventListener('click', togglePauseResume);
            document.getElementById('stopBtn').addEventListener('click', stopSpeech);
            initializeSpeechRecognition();
        });

        // Cancel speech synthesis on page unload
        window.addEventListener('beforeunload', () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        });

        function generatePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = ""; // Clear any existing links

            const maxLinks = 5; // Maximum number of links to display
            const halfRange = Math.floor(maxLinks / 2);

            // Calculate the start and end of the page range
            let startPage = Math.max(1, currentPage - halfRange);
            let endPage = Math.min(totalPages, currentPage + halfRange);

            // Adjust range if we’re near the start or end of total pages
            if (currentPage <= halfRange) {
                endPage = Math.min(totalPages, maxLinks);
            } else if (currentPage + halfRange > totalPages) {
                startPage = Math.max(1, totalPages - maxLinks + 1);
            }

            // Create "Previous" button
            if (currentPage > 1) {
                const prevLink = document.createElement('a');
                prevLink.href = `/lesson/laborlaw${currentPage - 1}`;
                prevLink.textContent = "Previous";
                paginationContainer.appendChild(prevLink);
                paginationContainer.appendChild(document.createTextNode(" | "));
            }

            // Generate numbered page links
            for (let i = startPage; i <= endPage; i++) {
                const pageLink = document.createElement('a');
                pageLink.href = `/lesson/laborlaw${i}`;
                pageLink.textContent = i;

                if (i === currentPage) {
                    pageLink.classList.add('active'); // Highlight current page
                }

                paginationContainer.appendChild(pageLink);

                if (i < endPage) {
                    paginationContainer.appendChild(document.createTextNode(" | "));
                }
            }

            // Create "Next" button
            if (currentPage < totalPages) {
                const nextLink = document.createElement('a');
                nextLink.href = `/lesson/laborlaw${currentPage + 1}`;
                nextLink.textContent = "Next";
                paginationContainer.appendChild(document.createTextNode(" | "));
                paginationContainer.appendChild(nextLink);
            }
        }

        // Initialize pagination on page load
        document.addEventListener('DOMContentLoaded', () => {
            const currentPageMatch = window.location.pathname.match(/laborlaw(\d+)/);
            const currentPage = currentPageMatch ? parseInt(currentPageMatch[1], 10) : 1;
            const totalPages = 20; // Adjust this to your actual total page count

            generatePagination(currentPage, totalPages);
        });

        //for table of content
        const tocToggleBtn = document.getElementById('tocToggleBtn');
        const tocContainer = document.getElementById('tocContainer');

        tocToggleBtn.addEventListener('click', () => {
            tocContainer.classList.toggle('open');
        });

    </script>
</body>

</html>